# Cloudprober configuration with Consul service discovery (RDS)
#
# This example demonstrates how to use Consul for service discovery.
# Cloudprober will discover services registered in Consul and probe them.

# RDS Server configuration
rds_server {
  provider {
    id: "consul"
    consul_config {
      # Consul server address
      address: "localhost:8500"

      # Optional: specify datacenter
      # datacenter: "dc1"

      # Optional: Consul token for authentication
      # token: "your-consul-token"

      # Optional: TLS configuration
      # tls {
      #   ca_file: "/path/to/ca.crt"
      #   cert_file: "/path/to/client.crt"
      #   key_file: "/path/to/client.key"
      # }

      # Optional: Use Kubernetes service discovery for Consul address
      # kubernetes_service {
      #   namespace: "default"
      #   service_name: "consul"
      #   port: "8500"
      # }

      # Services configuration
      services {
        # Filter services by tags (all tags must match)
        tag_filter: "http"
        tag_filter: "production"

        # Filter services by name (regex)
        name_filter: "web-.*"

        # Include service metadata as labels
        include_metadata: true

        # Include service tags as labels
        include_tags: true

        # Health status filter (only return healthy services)
        health_status: "passing"
      }

      # Refresh interval in seconds
      re_eval_sec: 30
    }
  }
}

# Probe configuration using Consul RDS
probe {
  name: "consul_services_http"
  type: HTTP

  # Use Consul RDS for targets
  targets {
    rds_targets {
      # Resource path format: "services" or "services/service-name"
      resource_path: "consul://services"

      # Optional filters
      filter {
        key: "name"
        value: "web-.*"
      }

      filter {
        key: "labels.service"
        value: "web-frontend"
      }
    }
  }

  http_probe {
    relative_url: "/health"
  }

  interval_msec: 10000  # 10 seconds
  timeout_msec: 5000    # 5 seconds
}

# Alternative: Probe specific services
probe {
  name: "consul_api_service"
  type: HTTP

  targets {
    rds_targets {
      # Target specific service
      resource_path: "consul://services/api"

      # Filter by health status
      filter {
        key: "labels.health"
        value: "passing"
      }
    }
  }

  http_probe {
    relative_url: "/api/health"
  }

  interval_msec: 30000
}

# Surfacer to export metrics
surfacer {
  type: PROMETHEUS
}

# Optional: File surfacer for debugging
surfacer {
  type: FILE
  file_surfacer {
    file_path: "/tmp/cloudprober_metrics.txt"
  }
}
