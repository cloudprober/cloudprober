# Cloudprober configuration with Consul surfacer
#
# This example demonstrates how to register Cloudprober instance with Consul.
# The surfacer will publish the instance's existence, health status, and metadata.

# Probe configuration
probe {
  name: "google_homepage"
  type: HTTP
  targets {
    host_names: "www.google.com"
  }
  http_probe {}
  interval_msec: 5000
  timeout_msec: 1000
}

# Consul surfacer - registers this Cloudprober instance with Consul
surfacer {
  type: CONSUL

  consul_surfacer {
    # Consul server address
    address: "localhost:8500"

    # Optional: specify datacenter
    # datacenter: "dc1"

    # Optional: Consul token for authentication
    # token: "your-consul-token"

    # Optional: TLS configuration
    # tls {
    #   ca_file: "/path/to/ca.crt"
    #   cert_file: "/path/to/client.crt"
    #   key_file: "/path/to/client.key"
    # }

    # Optional: Use Kubernetes service discovery for Consul address
    # kubernetes_service {
    #   namespace: "default"
    #   service_name: "consul"
    #   port: "8500"
    # }

    # Service registration configuration
    service {
      name: "cloudprober"

      # Optional: custom service ID
      # id: "cloudprober-prod-1"

      # Service tags
      tags: "monitoring"
      tags: "cloudprober"
      tags: "production"

      # Service port (defaults to 9313)
      port: 9313

      # Optional: custom service address
      # address: "10.0.1.100"

      # Enable Consul Connect (service mesh)
      # enable_connect: false
    }

    # Health check configuration
    health_check {
      # HTTP endpoint for health checks
      http_endpoint: "/status"

      # Health check interval
      interval: "10s"

      # Health check timeout
      timeout: "5s"

      # Deregister service after this duration if unhealthy
      deregister_critical_service_after: "1m"

      # HTTP method for health check
      http_method: "GET"

      # Optional: notes for the health check
      notes: "Cloudprober instance health check"
    }

    # Custom metadata to include in service registration
    metadata {
      key: "environment"
      value: "production"
    }
    metadata {
      key: "region"
      value: "us-west-2"
    }
    metadata {
      key: "team"
      value: "monitoring"
    }

    # Deregister service on shutdown (default: true)
    deregister_on_shutdown: true
  }
}

# Also export metrics to Prometheus
surfacer {
  type: PROMETHEUS
  prometheus_surfacer {
    # Metrics will be available at http://localhost:9313/metrics
  }
}

# Optional: File surfacer for debugging
surfacer {
  type: FILE
  file_surfacer {
    file_path: "/tmp/cloudprober_metrics.txt"
  }
}
