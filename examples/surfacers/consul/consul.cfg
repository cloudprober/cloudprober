# Register Cloudprober instance with Consul
#
# This configuration registers the Cloudprober instance as a service in Consul,
# making it discoverable by other services and monitoring tools.

# Example probe (required for cloudprober to run)
probe {
  name: "google_homepage"
  type: HTTP
  targets {
    host_names: "www.google.com"
  }
  http_probe {}
  interval_msec: 5000
}

# Consul surfacer - registers this Cloudprober instance with Consul
surfacer {
  type: CONSUL

  consul_surfacer {
    # Consul server address
    address: "localhost:8500"

    # Service registration configuration
    service {
      name: "cloudprober"

      # Service tags for discovery
      tags: "monitoring"
      tags: "cloudprober"
      tags: "production"

      # Port where cloudprober serves metrics (default: 9313)
      port: 9313
    }

    # Health check configuration
    health_check {
      # HTTP endpoint for health checks
      http_endpoint: "/status"

      # Check interval
      interval: "10s"

      # Timeout for health checks
      timeout: "5s"

      # Deregister service after this duration if unhealthy
      deregister_critical_service_after: "1m"

      # Optional: notes for the health check
      notes: "Cloudprober instance health check"
    }

    # Custom metadata
    metadata {
      key: "environment"
      value: "production"
    }
    metadata {
      key: "region"
      value: "us-west-2"
    }
    metadata {
      key: "team"
      value: "monitoring"
    }

    # Deregister service on shutdown (default: true)
    deregister_on_shutdown: true
  }
}

# Also export metrics to Prometheus
surfacer {
  type: PROMETHEUS
}

# Optional: Advanced configuration with TLS and Kubernetes service discovery
# surfacer {
#   type: CONSUL
#   consul_surfacer {
#     # Use Kubernetes service discovery for Consul address
#     kubernetes_service {
#       namespace: "default"
#       service_name: "consul"
#       port: "8500"
#     }
#
#     # TLS configuration
#     tls {
#       ca_file: "/etc/cloudprober/ca.crt"
#       cert_file: "/etc/cloudprober/client.crt"
#       key_file: "/etc/cloudprober/client.key"
#     }
#
#     datacenter: "dc1"
#     token: "your-consul-token"
#
#     service {
#       name: "cloudprober"
#       tags: "monitoring"
#
#       # Enable Consul Connect (service mesh)
#       enable_connect: true
#     }
#   }
# }
