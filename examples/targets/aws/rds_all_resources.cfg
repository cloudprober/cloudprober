# This config demonstrates comprehensive AWS resource discovery using RDS.
#
# This example shows how to discover and probe multiple AWS resource types:
# - EC2 instances
# - RDS database instances
# - RDS database clusters
# - ElastiCache clusters
# - ElastiCache replication groups
#
# Prerequisites:
# - AWS credentials configured
# - Resources deployed in the specified region
#
# Run with:
#   cloudprober --config_file=rds_all_resources.cfg

# Configure RDS server with AWS provider
rds_server {
  provider {
    aws_config {
      region: "us-east-1"

      # Optional: Use a specific AWS profile for authentication
      # profile_name: "production"

      # Discover EC2 instances
      ec2_instances {
        re_eval_sec: 300  # Refresh every 5 minutes
      }

      # Discover RDS database instances
      rds_instances {
        # Optional: Filter by specific instance
        # identifier: "my-database-instance"

        # Optional: Use AWS API filters
        # filter: "db-instance-status=available"

        # Optional: Include instances shared from other accounts
        # include_shared: true

        re_eval_sec: 300
      }

      # Discover RDS database clusters (for Aurora, etc.)
      rds_clusters {
        re_eval_sec: 300
      }

      # Discover ElastiCache clusters
      elasticache_clusters {
        re_eval_sec: 300
      }

      # Discover ElastiCache replication groups
      elasticache_replicationgroups {
        re_eval_sec: 300
      }
    }
  }
}

# Probe EC2 instances
probe {
  name: "ec2-instances"
  type: HTTP

  targets {
    rds_targets {
      resource_path: "aws://ec2_instances"
    }
  }

  http_probe {
    relative_url: "/health"
    port: 80
  }

  interval_msec: 60000
  timeout_msec: 10000
}

# Probe RDS database instances
probe {
  name: "rds-instances"
  type: TCP

  targets {
    rds_targets {
      resource_path: "aws://rds_instances"
    }
  }

  tcp_probe {
    # Most RDS instances use port 3306 (MySQL) or 5432 (PostgreSQL)
    port: 3306
  }

  interval_msec: 60000
  timeout_msec: 5000
}

# Probe RDS clusters
probe {
  name: "rds-clusters"
  type: TCP

  targets {
    rds_targets {
      resource_path: "aws://rds_clusters"
    }
  }

  tcp_probe {
    port: 3306
  }

  interval_msec: 60000
  timeout_msec: 5000
}

# Probe ElastiCache clusters
probe {
  name: "elasticache-clusters"
  type: TCP

  targets {
    rds_targets {
      resource_path: "aws://elasticache_clusters"
    }
  }

  tcp_probe {
    # Redis default port
    port: 6379
  }

  interval_msec: 60000
  timeout_msec: 5000
}

# Probe ElastiCache replication groups
probe {
  name: "elasticache-replicationgroups"
  type: TCP

  targets {
    rds_targets {
      resource_path: "aws://elasticache_replicationgroups"
    }
  }

  tcp_probe {
    port: 6379
  }

  interval_msec: 60000
  timeout_msec: 5000
}
