# Cloudprober probe configuration using Consul for target discovery
#
# This example demonstrates how to use Consul to discover targets for probing.

# Probe HTTP services discovered from Consul
probe {
  name: "consul_http_services"
  type: HTTP

  # Terser syntax: direct Consul targets
  targets {
    consul {
      address: "localhost:8500"

      # Discover all services matching the pattern
      services: "web-.*"

      # Filter by tags (all must match)
      tags: "http"
      tags: "production"

      # Only target healthy services
      health_status: "passing"

      # Refresh targets every 30 seconds
      re_eval_sec: 30
    }
  }

  http_probe {
    relative_url: "/health"
  }

  interval_msec: 10000  # 10 seconds
  timeout_msec: 5000    # 5 seconds
}

# Alternative: Probe a specific Consul service by name
probe {
  name: "api_service"
  type: HTTP

  targets {
    consul {
      address: "localhost:8500"
      services: "api"  # Exact service name
      health_status: "passing"
    }
  }

  http_probe {
    relative_url: "/api/health"
  }

  interval_msec: 30000
}

# Advanced: Use additional filters
probe {
  name: "filtered_services"
  type: HTTP

  targets {
    consul {
      address: "localhost:8500"
      services: ""  # All services

      # Additional filters using RDS filter syntax
      filter {
        key: "labels.service"
        value: "frontend"
      }

      filter {
        key: "node"
        value: "prod-.*"  # Nodes matching pattern
      }
    }
  }

  http_probe {}
  interval_msec: 15000
}

# Optional: Configure Consul with TLS
# probe {
#   name: "secure_consul"
#   type: HTTP
#   targets {
#     consul {
#       address: "consul.example.com:8501"
#       datacenter: "dc1"
#       token: "your-consul-token"  # Or use CONSUL_HTTP_TOKEN env var
#       services: "web-.*"
#     }
#   }
#   http_probe {}
# }

# Export metrics
surfacer {
  type: PROMETHEUS
}
